<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking ¬∑ Ciudadan√≠a</title>

    <link rel="icon" type="image/png" sizes="16x16"  href="../../assets/images/icons/favicons/favicon_16.png">
    <link rel="icon" type="image/png" sizes="32x32"  href="../../assets/images/icons/favicons/favicon_32.png">
    <link rel="icon" type="image/png" sizes="48x48"  href="../../assets/images/icons/favicons/favicon_48.png">
    <link rel="icon" type="image/png" sizes="64x64"  href="../../assets/images/icons/favicons/favicon_64.png">
    <link rel="icon" type="image/png" sizes="128x128" href="../../assets/images/icons/favicons/favicon_128.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../assets/images/icons/favicons/favicon_180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../../assets/images/icons/favicons/favicon_192.png">
    <link rel="icon" type="image/png" sizes="256x256" href="../../assets/images/icons/favicons/favicon_256.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../../assets/images/icons/favicons/favicon_512.png">
    
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* ESTILOS ESPEC√çFICOS RANKING (CIUDADANOS) */
        .ranking-container { margin-top: 1rem; }
        
        .ranking-controls {
            display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem; align-items: flex-end;
            background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .control-group { flex: 1; min-width: 220px; }
        .control-group label { 
            display: block; font-weight: 700; color: #f97316; /* Naranja */
            font-size: 0.85rem; margin-bottom: 6px; text-transform: uppercase;
        }
        .control-group select {
            width: 100%; padding: .6rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; background-color: #fff; cursor: pointer; transition: border-color 0.2s;
        }
        .control-group select:hover { border-color: #f97316; }
        .control-group select:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 3px rgba(249,115,22,0.2); }
        .control-group select:disabled { background-color: #f3f4f6; color: #999; cursor: not-allowed; }

        table {
            width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 10px;
        }

        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background: #fff7ed; font-weight: 700; color: #c2410c; font-size: 0.9rem; text-transform: uppercase; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #fffbf4; }

        /* Medallas */
        .rank-1 { font-size: 1.2rem; } 
        .rank-2 { font-size: 1.1rem; } 
        .rank-3 { font-size: 1.1rem; }

        /* Bot√≥n Jugar este nivel */
        .play-btn-container { flex: 0 0 auto; text-align: right; }
        .play-btn {
            background: #f97316; /* Naranja */
            padding: .7rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(249, 115, 22, 0.2);
        }
        .play-btn:hover { background: #ea580c; transform: translateY(-2px); }
        .play-btn.disabled { 
            background: #e5e7eb; color: #999; pointer-events: none; box-shadow: none; transform: none; 
        }

        .empty-state { padding: 40px; text-align: center; color: #888; font-style: italic; }
    </style>
</head>

<body>

<header class="sp-header">
    <button id="menu-toggle" class="menu-toggle"><i class="fa-solid fa-bars"></i></button>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="sp-header-left">
        <img src="../../assets/images/icons/logos/logo_Estrategia.png" class="sp-logo">
    </div>
    <h1 class="sp-title">Estrategia para la Seguridad del Paciente</h1>
    <div class="sp-header-right">
        <img src="../../assets/images/icons/logos/logo_CSPyE.svg" class="sp-logo-right">
    </div>
</header>

<div class="sp-layout">

    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-trophy"></i>
            <span>Ranking</span>
        </div>
        <nav class="sidebar-nav">
            <div class="sidebar-group">
                <div style="padding: 0 10px 5px; font-size:0.85rem; color:#8A5B00; font-weight:bold; text-transform:uppercase;">
                    Volver a
                </div>
                <a href="juega.html" class="sidebar-btn">
                    <i class="fa-solid fa-gamepad"></i> Zona de Juegos
                </a>
            </div>
            <div class="sidebar-group" style="margin-top: 20px; border-top: 1px solid #F2C273; padding-top: 20px;">
                <a href="../../ciudadanos.html" class="sidebar-btn" style="background-color: #FFE4B3;">
                    <i class="fa-solid fa-users"></i> Ciudadan√≠a
                </a>
                <a href="../../index.html" class="sidebar-btn" style="background-color: #FFE4B3; margin-top:10px;">
                    <i class="fa-solid fa-house"></i> Inicio
                </a>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <h2><i class="fa-solid fa-chart-line" style="color:#f97316;"></i> Clasificaci√≥n Global</h2>
        <p class="main-intro">Consulta las mejores puntuaciones de la comunidad.</p>

        <div class="ranking-container">
            
            <div class="ranking-controls">
                <div class="control-group">
                    <label for="selectJuego"><i class="fa-solid fa-gamepad"></i> Juego / Actividad</label>
                    <select id="selectJuego">
                        <option value="" disabled selected>-- Selecciona un juego --</option>
                        <option value="detectives">Detectives del Hogar</option>
                        <option value="semaforo">Sem√°foro de Urgencias</option>
                        <option value="mochila">La Mochila Segura</option>
                        <option value="adivina">Adivina la Medicina</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="selectNivel"><i class="fa-solid fa-layer-group"></i> Nivel / Escenario</label>
                    <select id="selectNivel" disabled>
                        <option value="">-- Primero selecciona juego --</option>
                    </select>
                </div>

                <div class="play-btn-container">
                     <a id="btnJugar" class="play-btn disabled" href="#">
                        <i class="fa-solid fa-play"></i> Jugar este nivel
                    </a>
                </div>
            </div>

            <table id="rankingTable">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align:center">#</th>
                        <th>Jugador</th>
                        <th>Puntos</th>
                        <th>Tiempo</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="empty-state">Selecciona un juego y nivel para ver los resultados.</td></tr>
                </tbody>
            </table>
        </div>
        
        <footer class="sp-footer">
            √Årea de Gesti√≥n Sanitaria Sur de C√≥rdoba ¬∑ Consejer√≠a de Sanidad, Presidencia y Emergencias
        </footer>
        
    </main>
</div>

<script src="../../js/sidebar.js"></script>

<script type="module">
    import { getRanking } from "../../js/core/scores.js";

    const selectJuego = document.getElementById("selectJuego");
    const selectNivel = document.getElementById("selectNivel");
    const rankingTable = document.querySelector("#rankingTable tbody");
    const btnJugar = document.getElementById("btnJugar");

    // CONFIGURACI√ìN: Aqu√≠ definimos d√≥nde est√° cada juego y sus niveles
    const CONFIG = {
        "detectives": {
            ruta: "detectives/detectives.html",
            niveles: [ 
                { id: "salon", nombre: "El Sal√≥n" },
                { id: "bano", nombre: "El Ba√±o" },
                { id: "cocina", nombre: "La Cocina" }
            ]
        },
        "semaforo": {
            ruta: "semaforo/semaforo.html",
            niveles: [ { id: "ciudadanos", nombre: "General" } ]
        },
        "mochila": {
            ruta: "mochila/mochila.html",
            niveles: [ { id: "ciudadanos", nombre: "General" } ]
        },
        "adivina": {
            ruta: "adivina/adivina.html",
            niveles: [ { id: "nivel1", nombre: "Nivel √önico" } ]
        }
    };

    // 1. CAMBIO DE JUEGO
    selectJuego.addEventListener("change", () => {
        const juegoId = selectJuego.value;
        const config = CONFIG[juegoId];

        selectNivel.innerHTML = '<option value="" disabled selected>-- Selecciona nivel --</option>';
        
        if (config) {
            // Habilitar y llenar niveles
            selectNivel.disabled = false;
            config.niveles.forEach(n => {
                const opt = document.createElement("option");
                opt.value = n.id;
                opt.textContent = n.nombre;
                selectNivel.appendChild(opt);
            });

            // ACTUALIZAR EL ENLACE DEL BOT√ìN (Solo la base, el nivel se podr√≠a pasar por URL si el juego lo soportase)
            // De momento, el juego detectar√° el nivel por URL si implementamos esa l√≥gica en el futuro, 
            // pero por ahora abre la portada del juego.
            btnJugar.href = config.ruta;
            
            // Seleccionar autom√°ticamente el primero si solo hay uno
            if(config.niveles.length === 1) {
                selectNivel.value = config.niveles[0].id;
                selectNivel.dispatchEvent(new Event('change'));
            }
        } else {
            selectNivel.disabled = true;
            btnJugar.classList.add("disabled");
        }
    });

    // 2. CAMBIO DE NIVEL -> CARGAR DATOS
    selectNivel.addEventListener("change", cargarDatosRanking);

    async function cargarDatosRanking() {
        const juego = selectJuego.value;
        const nivel = selectNivel.value;

        if (!juego || !nivel) return;

        // Habilitar bot√≥n jugar
        btnJugar.classList.remove("disabled");
        
        // Si el juego es detectives, podemos pasarle el escenario por URL para que abra directo ese nivel
        // (Esto requiere que detectives.js lea la URL, pero el enlace queda preparado)
        if (juego === "detectives") {
             btnJugar.href = `${CONFIG[juego].ruta}?escenario=${nivel}`;
        }

        rankingTable.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="color:#f97316; font-size:1.5rem"></i><br><br>Cargando...
        </td></tr>`;

        try {
            const datos = await getRanking(juego, nivel);

            rankingTable.innerHTML = "";

            if (!datos || datos.length === 0) {
                rankingTable.innerHTML = `<tr><td colspan="5" class="empty-state">No hay r√©cords a√∫n. ¬°S√© el primero!</td></tr>`;
                return;
            }

            datos.forEach((r, i) => {
                const tr = document.createElement("tr");
                
                let rankIcon = `<strong>${i + 1}</strong>`;
                if (i === 0) rankIcon = `<span class="rank-1">ü•á</span>`;
                if (i === 1) rankIcon = `<span class="rank-2">ü•à</span>`;
                if (i === 2) rankIcon = `<span class="rank-3">ü•â</span>`;

                let fechaStr = r.fecha ? new Date(r.fecha).toLocaleDateString() : "‚Äî";
                let tiempoStr = r.tiempo ? `${r.tiempo}s` : "‚Äî";

                tr.innerHTML = `
                    <td style="text-align:center">${rankIcon}</td>
                    <td><strong style="color:#333">${r.jugador || "An√≥nimo"}</strong></td>
                    <td style="font-weight:bold; color:#c2410c; font-size:1.1rem">${r.puntuacion}</td>
                    <td>${tiempoStr}</td>
                    <td style="font-size:0.9rem; color:#888">${fechaStr}</td>
                `;
                rankingTable.appendChild(tr);
            });

        } catch (error) {
            console.error(error);
            rankingTable.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error de conexi√≥n.</td></tr>`;
        }
    }

    // Comprobar si venimos rebotados de un juego (?juego=semaforo)
    const params = new URLSearchParams(window.location.search);
    const urlJuego = params.get('juego');
    const urlNivel = params.get('nivel'); // Si el juego nos pasa el nivel (ej: ciudadanos)

    if(urlJuego && CONFIG[urlJuego]) {
        selectJuego.value = urlJuego;
        // Forzamos el evento change para cargar los niveles
        selectJuego.dispatchEvent(new Event('change'));
        
        // Si tambi√©n ven√≠a el nivel (ej: ?juego=semaforo&nivel=ciudadanos), lo seleccionamos
        if (urlNivel) {
            // Peque√±o timeout para dar tiempo a que se cree el <option> en el DOM
            setTimeout(() => {
                selectNivel.value = urlNivel;
                selectNivel.dispatchEvent(new Event('change'));
            }, 50);
        }
    }

</script>

</body>
</html>